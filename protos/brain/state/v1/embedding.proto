syntax = "proto3";

package brain.state.v1;

import "brain/shared/v1/envelope.proto";
import "google/protobuf/timestamp.proto";

service EmbeddingAuthorityService {
  rpc UpsertSpec(UpsertSpecRequest) returns (UpsertSpecResponse);
  rpc SetActiveSpec(SetActiveSpecRequest) returns (SetActiveSpecResponse);

  rpc UpsertSource(UpsertSourceRequest) returns (UpsertSourceResponse);
  rpc UpsertChunk(UpsertChunkRequest) returns (UpsertChunkResponse);
  rpc UpsertChunks(UpsertChunksRequest) returns (UpsertChunksResponse);

  rpc UpsertEmbeddingVector(UpsertEmbeddingVectorRequest)
      returns (UpsertEmbeddingVectorResponse);
  rpc UpsertEmbeddingVectors(UpsertEmbeddingVectorsRequest)
      returns (UpsertEmbeddingVectorsResponse);

  rpc DeleteChunk(DeleteChunkRequest) returns (DeleteChunkResponse);
  rpc DeleteSource(DeleteSourceRequest) returns (DeleteSourceResponse);

  rpc GetSource(GetSourceRequest) returns (GetSourceResponse);
  rpc ListSources(ListSourcesRequest) returns (ListSourcesResponse);

  rpc GetChunk(GetChunkRequest) returns (GetChunkResponse);
  rpc ListChunksBySource(ListChunksBySourceRequest)
      returns (ListChunksBySourceResponse);

  rpc GetEmbedding(GetEmbeddingRequest) returns (GetEmbeddingResponse);
  rpc ListEmbeddingsBySource(ListEmbeddingsBySourceRequest)
      returns (ListEmbeddingsBySourceResponse);
  rpc ListEmbeddingsByStatus(ListEmbeddingsByStatusRequest)
      returns (ListEmbeddingsByStatusResponse);
  rpc SearchEmbeddings(SearchEmbeddingsRequest)
      returns (SearchEmbeddingsResponse);

  rpc GetActiveSpec(GetActiveSpecRequest) returns (GetActiveSpecResponse);
  rpc ListSpecs(ListSpecsRequest) returns (ListSpecsResponse);
  rpc GetSpec(GetSpecRequest) returns (GetSpecResponse);
}

enum EmbeddingStatus {
  EMBEDDING_STATUS_UNSPECIFIED = 0;
  EMBEDDING_STATUS_PENDING     = 1;
  EMBEDDING_STATUS_INDEXED     = 2;
  EMBEDDING_STATUS_FAILED      = 3;
}

message EmbeddingSpec {
  string id                            = 1;
  string provider                      = 2;
  string name                          = 3;
  string version                       = 4;
  uint32 dimensions                    = 5;
  bytes hash                           = 6;
  string canonical_string              = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
}

message SourceRecord {
  string id                            = 1;
  string source_type                   = 2;
  string canonical_reference           = 3;
  string service                       = 4;
  string principal                     = 5;
  map<string, string> metadata         = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

message ChunkRecord {
  string id                            = 1;
  string source_id                     = 2;
  int32 chunk_ordinal                  = 3;
  string reference_range               = 4;
  string content_hash                  = 5;
  map<string, string> metadata         = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
  string text                          = 9;
}

message EmbeddingRecord {
  string chunk_id                      = 1;
  string spec_id                       = 2;
  string content_hash                  = 3;
  EmbeddingStatus status               = 4;
  string error_detail                  = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

message UpsertSpecPayload {
  string provider   = 1;
  string name       = 2;
  string version    = 3;
  uint32 dimensions = 4;
}

message UpsertSpecRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  UpsertSpecPayload payload             = 2;
}

message UpsertSpecResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  EmbeddingSpec payload                    = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message SetActiveSpecPayload {
  string spec_id = 1;
}

message SetActiveSpecRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  SetActiveSpecPayload payload          = 2;
}

message SetActiveSpecResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  EmbeddingSpec payload                    = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message UpsertSourcePayload {
  string source_type           = 1;
  string canonical_reference   = 2;
  string service               = 3;
  string principal             = 4;
  map<string, string> metadata = 5;
}

message UpsertSourceRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  UpsertSourcePayload payload           = 2;
}

message UpsertSourceResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  SourceRecord payload                     = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message UpsertChunkPayload {
  string source_id            = 1;
  int32 chunk_ordinal         = 2;
  string reference_range      = 3;
  string content_hash         = 4;
  string text                 = 5;
  map<string, string> metadata = 6;
}

message UpsertChunkRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  UpsertChunkPayload payload            = 2;
}

message UpsertChunkResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  ChunkRecord payload                      = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message UpsertChunksPayload {
  repeated UpsertChunkPayload items = 1;
}

message UpsertChunksRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  UpsertChunksPayload payload           = 2;
}

message UpsertChunksResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated ChunkRecord payload             = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message UpsertEmbeddingVectorPayload {
  string chunk_id       = 1;
  string spec_id        = 2;
  repeated float vector = 3;
}

message UpsertEmbeddingVectorRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  UpsertEmbeddingVectorPayload payload  = 2;
}

message UpsertEmbeddingVectorResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  EmbeddingRecord payload                  = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message UpsertEmbeddingVectorsPayload {
  repeated UpsertEmbeddingVectorPayload items = 1;
}

message UpsertEmbeddingVectorsRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  UpsertEmbeddingVectorsPayload payload = 2;
}

message UpsertEmbeddingVectorsResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated EmbeddingRecord payload         = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message DeleteChunkPayload {
  string chunk_id = 1;
}

message DeleteChunkRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  DeleteChunkPayload payload            = 2;
}

message DeleteChunkResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  bool payload                             = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message DeleteSourcePayload {
  string source_id = 1;
}

message DeleteSourceRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  DeleteSourcePayload payload           = 2;
}

message DeleteSourceResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  bool payload                             = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message GetSourcePayload {
  string source_id = 1;
}

message GetSourceRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  GetSourcePayload payload              = 2;
}

message GetSourceResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  SourceRecord payload                     = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message ListSourcesPayload {
  string canonical_reference = 1;
  string service             = 2;
  string principal           = 3;
  int32 limit                = 4;
}

message ListSourcesRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  ListSourcesPayload payload            = 2;
}

message ListSourcesResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated SourceRecord payload            = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message GetChunkPayload {
  string chunk_id = 1;
}

message GetChunkRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  GetChunkPayload payload               = 2;
}

message GetChunkResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  ChunkRecord payload                      = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message ListChunksBySourcePayload {
  string source_id = 1;
  int32 limit      = 2;
}

message ListChunksBySourceRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  ListChunksBySourcePayload payload     = 2;
}

message ListChunksBySourceResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated ChunkRecord payload             = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message GetEmbeddingPayload {
  string chunk_id = 1;
  string spec_id  = 2;
}

message GetEmbeddingRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  GetEmbeddingPayload payload           = 2;
}

message GetEmbeddingResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  EmbeddingRecord payload                  = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message ListEmbeddingsBySourcePayload {
  string source_id = 1;
  string spec_id   = 2;
  int32 limit      = 3;
}

message ListEmbeddingsBySourceRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  ListEmbeddingsBySourcePayload payload = 2;
}

message ListEmbeddingsBySourceResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated EmbeddingRecord payload         = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message ListEmbeddingsByStatusPayload {
  EmbeddingStatus status = 1;
  string spec_id         = 2;
  int32 limit            = 3;
}

message ListEmbeddingsByStatusRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  ListEmbeddingsByStatusPayload payload = 2;
}

message ListEmbeddingsByStatusResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated EmbeddingRecord payload         = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message SearchEmbeddingMatch {
  float score            = 1;
  string chunk_id        = 2;
  string source_id       = 3;
  string spec_id         = 4;
  int32 chunk_ordinal    = 5;
  string reference_range = 6;
  string content_hash    = 7;
}

message SearchEmbeddingsPayload {
  repeated float query_vector = 1;
  string source_id            = 2;
  string spec_id              = 3;
  int32 limit                 = 4;
}

message SearchEmbeddingsRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  SearchEmbeddingsPayload payload       = 2;
}

message SearchEmbeddingsResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated SearchEmbeddingMatch payload    = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message GetActiveSpecRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
}

message GetActiveSpecResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  EmbeddingSpec payload                    = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message ListSpecsPayload {
  int32 limit = 1;
}

message ListSpecsRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  ListSpecsPayload payload              = 2;
}

message ListSpecsResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  repeated EmbeddingSpec payload           = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message GetSpecPayload {
  string spec_id = 1;
}

message GetSpecRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  GetSpecPayload payload                = 2;
}

message GetSpecResponse {
  brain.shared.v1.EnvelopeMeta metadata    = 1;
  EmbeddingSpec payload                    = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}
