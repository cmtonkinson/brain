syntax = "proto3";

package brain.action.v1;

import "brain/shared/v1/envelope.proto";

service CapabilityEngineService {
  rpc DescribeCapabilities(DescribeCapabilitiesRequest) returns (DescribeCapabilitiesResponse);
  rpc InvokeCapability(InvokeCapabilityRequest) returns (InvokeCapabilityResponse);
}

message DescribeCapabilitiesRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
}

message DescribeCapabilitiesResponse {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  repeated CapabilityDescriptor capabilities = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
}

message CapabilityDescriptor {
  string capability_id = 1;
  string kind = 2;
  string version = 3;
  string summary = 4;
  repeated string input_types = 5;
  repeated string output_types = 6;
  int32 autonomy = 7;
  bool requires_approval = 8;
  repeated string side_effects = 9;
  repeated string required_capabilities = 10;
}

message InvokeCapabilityRequest {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  CapabilityRef capability = 2;
  string input_json = 3;
  PolicyContext policy_context = 4;
}

message InvokeCapabilityResponse {
  brain.shared.v1.EnvelopeMeta metadata = 1;
  string output_json = 2;
  repeated brain.shared.v1.ErrorDetail errors = 3;
  PolicyDecisionSummary policy = 4;
}

message CapabilityRef {
  string kind = 1;
  string namespace = 2;
  string name = 3;
  string version = 4;
}

message PolicyContext {
  string actor = 1;
  string channel = 2;
  repeated string allowed_capabilities = 3;
  int32 max_autonomy = 4;
  bool confirmed = 5;
  string approval_token = 6;
  string invocation_id = 7;
  string parent_invocation_id = 8;
}

message PolicyDecisionSummary {
  string decision_id = 1;
  bool allowed = 2;
  repeated string reason_codes = 3;
  repeated string obligations = 4;
  string proposal_id = 5;
}
